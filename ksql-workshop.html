<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Pere Urbon &lt;@purbon&gt;, Robin Moffatt &lt;@rmoff&gt;">
<title>Workshop: Real-time SQL Stream Processing at Scale with Apache Kafka and KSQL</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="book">
<div id="header">
<h1>Workshop: Real-time SQL Stream Processing at Scale with Apache Kafka and KSQL</h1>
<div class="details">
<span id="author" class="author">Pere Urbon &lt;@purbon&gt;, Robin Moffatt &lt;@rmoff&gt;</span><br>
<span id="revnumber">version 1.32,</span>
<span id="revdate">March 26, 2019.</span>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>KSQL is the streaming SQL engine for Apache Kafka. Using just SQL it is possible for developers to build powerful stream processing applications. This talk will show practical examples of KSQL:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Filtering streams of data</p>
</li>
<li>
<p>Joining live events with reference data (e.g. from a database)</p>
</li>
<li>
<p>Stateful aggregations</p>
</li>
<li>
<p>Convert streams from JSON to AVRO</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ksql_workshop_01.png" alt="Diagram of what&#8217;s being built with the KSQL demo">
</div>
</div>
<div class="paragraph">
<p>You can find all of the KSQL commands used during this workshop in the <code>ksql-workshop.sql</code> file.</p>
</div>
<div class="paragraph">
<p>The slides that go with it <a href="https://speakerdeck.com/rmoff/javazone-workshop-apache-kafka-and-ksql-in-action-lets-build-a-streaming-data-pipeline">can be found here</a>.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to check out the #ksql channel on our <a href="https://slackpass.io/confluentcommunity">Community Slack group</a></p>
</div>
<div class="paragraph">
<p>——<em>Robin Moffatt <a href="https://twitter.com/rmoff/">@rmoff</a></em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites">2. Prerequisites</h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
These <strong>MUST</strong> be completed before the workshop!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please see <a href="pre-requisites.adoc" class="bare">pre-requisites.adoc</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_start_confluent_platform">3. Start Confluent Platform</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>NOTE: Make sure that Docker has at least 8GB of memory available (check with <code>docker system info | grep Memory</code>)</em></p>
</div>
<div class="paragraph">
<p>Change the working directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd examples/ksql-workshop</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start Confluent Platform:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose up -d
docker-compose logs -f kafka|grep "INFO Kafka version"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you see output then it means Kafka is running and you can proceed</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-compose logs -f kafka|grep "INFO Kafka version"
kafka_1             | [2018-09-03 14:08:09,790] INFO Kafka version : 2.0.0-cp1 (org.apache.kafka.common.utils.AppInfoParser)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C twice to exit the <code>docker-compose logs</code> command</p>
</div>
<div class="paragraph">
<p>Run <code>docker-compose ps</code> to confirm that all components are running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-compose ps
              Name                            Command               State                          Ports
--------------------------------------------------------------------------------------------------------------------------------
ksql-workshop_connect-debezium_1   /docker-entrypoint.sh start      Up      0.0.0.0:8083-&gt;8083/tcp, 8778/tcp, 9092/tcp, 9779/tcp
ksql-workshop_datagen-ratings_1    bash -c echo Waiting for K ...   Up
ksql-workshop_elasticsearch_1      /usr/local/bin/docker-entr ...   Up      0.0.0.0:9200-&gt;9200/tcp, 9300/tcp
ksql-workshop_kafka-connect-cp_1   /etc/confluent/docker/run        Up      0.0.0.0:18083-&gt;18083/tcp, 8083/tcp, 9092/tcp
ksql-workshop_kafka_1              /etc/confluent/docker/run        Up      0.0.0.0:9092-&gt;9092/tcp
ksql-workshop_kibana_1             /usr/local/bin/kibana-docker     Up      0.0.0.0:5601-&gt;5601/tcp
ksql-workshop_ksql-server_1        /etc/confluent/docker/run        Up      8088/tcp
ksql-workshop_mysql_1              docker-entrypoint.sh mysqld      Up      3306/tcp, 33060/tcp
ksql-workshop_schema-registry_1    /etc/confluent/docker/run        Up      8081/tcp
ksql-workshop_zookeeper_1          /etc/confluent/docker/run        Up      2181/tcp, 2888/tcp, 3888/tcp</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
If any components do not show "Up" under the <code>State</code> column (e.g. they say "Exit") then you must rectify this before continuing. As a first solution, try re-issuing the <code>docker-compose up -d command</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_source_data_rating_events">4. Source Data : Rating events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The event stream driving this example is a simulated stream of events purporting to show the ratings left by users on a website, with data elements including the device type that they used, the star rating, and a message associated with the rating.</p>
</div>
<div class="sect2">
<h3 id="_inspect_the_ratings_data">4.1. Inspect the ratings data</h3>
<div class="paragraph">
<p>Here we use <a href="https://github.com/edenhill/kafkacat/"><code>kafkacat</code> </a> for showing the Kafka messages and detailed metadata.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --network ksql-workshop_default \
          --tty --interactive --rm \
          confluentinc/cp-kafkacat \
          kafkacat -b kafka:29092 -C -K: \
          -f '\nKey (%K bytes): %k\t\nValue (%S bytes): %s\n\Partition: %p\tOffset: %o\n--\n' \
          -t ratings</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the data is in Avro, so you will see lots of special characters in the output.</p>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the command prompt.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
On Linux the name of the network <em>may</em> be <code>ksqlworkshop_default</code> (no <code>-</code> between <code>ksql</code> and <code>workshop</code>). Use <code>docker network ls</code> to check, and modify the <code>docker run</code> command above (and subsequently in this workshop) accordingly.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_source_data_customers">5. Source Data : Customers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_populate_customer_data">5.1. Populate customer data</h3>
<div class="paragraph">
<p>Depending on time available, and your interest in exploring database integration with Kafka, you may opt for one of the two methods below for getting customer data into Kafka.</p>
</div>
<div class="sect3">
<h4 id="_option_a_rdbms">5.1.1. Option A: RDBMS</h4>
<div class="paragraph">
<p><strong>This shows how to ingest the data using <a href="https://www.confluent.io/blog/no-more-silos-how-to-integrate-your-databases-with-apache-kafka-and-cdc">Kafka Connect and CDC</a>. If you want, you can replace this step with the following one ("Option B").</strong></p>
</div>
<div class="paragraph">
<p>Check that Kafka Connect with Debezium&#8217;s connector has started:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose logs -f connect-debezium|grep "Kafka Connect started"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait for the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">connect-debezium_1  | 2018-09-04 11:33:04,639 INFO   ||  Kafka Connect started   [org.apache.kafka.connect.runtime.Connect]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to return to the command prompt.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll now create <em>two</em> Kafka Connect connectors. Both stream events from MySQL into Kafka using Debezium, but differ in how they handle the message structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec connect-debezium bash -c '/scripts/create-mysql-source.sh'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see <code>HTTP/1.1 201 Created</code>, twice.</p>
</div>
<div class="paragraph">
<p>If you are interested you can inspect the script file (<code>scripts/create-mysql-source.sh</code> in the workshop folder) that includes the configuration payload in JSON.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The connector called <code>mysql-source-demo-customers</code> flattens the before/after record state data, along with the nested metadata, into a single flat structure. This is what we use during the rest of the workshop.</p>
<div class="paragraph">
<p>The flattening is done using a <strong>Single Message Transform</strong> from Debezium, called <code>io.debezium.transforms.UnwrapFromEnvelope</code>.
+ The connector also uses two Single Message Transforms to illustrate how metadata can be added to ingested data. The <code>InsertField</code> transformation adds the topic name into a field called <code>messagetopic</code>, and some fixed text into the <code>messagesource</code> field.</p>
</div>
</li>
<li>
<p>The connector <code>mysql-source-demo-customers-raw</code> retains the nested structure of the before/after record data.</p>
<div class="paragraph">
<p>A Single Message Transform is used to route the messages to a different topic. By default Debezium will use the format <code>server.schema.table</code> when streaming a table&#8217;s data to a Kafka topic. We use the <code>RegexRouter</code> to redirect the messages to a topic with a <code>-raw</code> suffix.</p>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_exploring_cdc_change_records">Exploring CDC change records</h5>
<div class="paragraph">
<p>Start a MySQL command prompt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec mysql bash -c 'mysql -u $MYSQL_USER -p$MYSQL_PASSWORD demo'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now in a separate terminal window run the following, to stream the contents of the customers topic and any changes to stdout:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash"># Make sure you run this from the `examples/ksql-workshop` folder
docker-compose exec -T kafka \
      kafka-console-consumer \
      --bootstrap-server kafka:29092 \
      --topic asgard.demo.CUSTOMERS-raw --from-beginning|jq '.'</code></pre>
</div>
</div>
<div class="paragraph">
<p>(<em><a href="https://stedolan.github.io/jq/">jq</a> is useful here—if you don&#8217;t have it installed, remove <code>|jq '.'</code> from the above command).</em></p>
</div>
<div class="paragraph">
<p>Note the customer data shown, and the structure of it, with <code>before</code>, <code>after</code>, and <code>source</code> data.</p>
</div>
<div class="paragraph">
<p>From the MySQL command prompt, make some changes to the data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">INSERT INTO CUSTOMERS (ID,FIRST_NAME,LAST_NAME) VALUES (42,'Rick','Astley');
UPDATE CUSTOMERS SET FIRST_NAME = 'Thomas', LAST_NAME ='Smith' WHERE ID=2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see each DML cause an almost-instantaneous update on the Kafka topic. For each change, inspect the output of the Kafka topic. Observe the difference between an <code>INSERT</code> and <code>UPDATE</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_option_b_manually">5.1.2. Option B: Manually</h4>
<div class="paragraph">
<p>If you want to follow the simpler path for this workshop, you can just mock up the data that would be coming from our customers table on a database. In practice you would ingest the data using <a href="https://www.confluent.io/blog/no-more-silos-how-to-integrate-your-databases-with-apache-kafka-and-cdc">Kafka Connect and CDC</a></p>
</div>
<div class="paragraph">
<p>Run the following command to send the customer data to the <code>customers</code> topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --network ksql-workshop_default \
           --interactive --rm \
           --volume $PWD/data:/data confluentinc/cp-kafkacat \
           kafkacat -b kafka:29092 \
                    -t asgard.demo.CUSTOMERS \
                    -P -l /data/customers.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that there is no output from this command. We will verify its success in the next step.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inspect_customer_data">5.2. Inspect customer data</h3>
<div class="paragraph">
<p>Run this command to inspect the content of the main <code>asgard.demo.CUSTOMERS</code> topic that we populated.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --network ksql-workshop_default \
          --tty --interactive --rm \
          confluentinc/cp-kafkacat \
          kafkacat -b kafka:29092 -C -K: \
          -f '\nKey (%K bytes): %k\t\nValue (%S bytes): %s\n\Partition: %p\tOffset: %o\n--\n' \
          -t asgard.demo.CUSTOMERS</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see messages, similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Key (-1 bytes):
Value (168 bytes): {"id":1,"first_name":"Annemarie","last_name":"Arent","email":"aarent0@cpanel.net","gender":"Female","club_status":"platinum","comments":"Organized web-enabled ability"}
Partition: 0    Offset: 0
--</pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the command prompt.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ksql_cli">6. KSQL CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KSQL can be used via the command line interface (CLI), a graphical UI built into Confluent Control Center, or the documented <a href="https://docs.confluent.io/current/ksql/docs/api.html">REST API</a>.</p>
</div>
<div class="paragraph">
<p>In this workshop we will use the CLI, which if you have used Oracle&#8217;s sql*plus, MySQL CLI, and so on will feel very familiar to you.</p>
</div>
<div class="paragraph">
<p>Launch the CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run --network ksql-workshop_default \
           --tty --interactive --rm \
           confluentinc/cp-ksql-cli:5.1.0 http://ksql-server:8088</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure that you get a successful start up screen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">                  ===========================================
                  =        _  __ _____  ____  _             =
                  =       | |/ // ____|/ __ \| |            =
                  =       | ' /| (___ | |  | | |            =
                  =       |  &lt;  \___ \| |  | | |            =
                  =       | . \ ____) | |__| | |____        =
                  =       |_|\_\_____/ \___\_\______|       =
                  =                                         =
                  =  Streaming SQL Engine for Apache Kafka® =
                  ===========================================

Copyright 2017-2018 Confluent Inc.

CLI v5.1.0, Server v5.1.0 located at http://ksql-server:8088

Having trouble? Type 'help' (case-insensitive) for a rundown of how things work!

ksql&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_see_available_kafka_topics">6.1. See available Kafka topics</h3>
<div class="paragraph">
<p>KSQL can be used to view the topic metadata on a Kafka cluster (<code>SHOW TOPICS;</code>), as well as inspect the messages in a topic (<code>PRINT &lt;topic&gt;;</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SHOW TOPICS;

 Kafka Topic                     | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups
-------------------------------------------------------------------------------------------------------------
 _confluent-metrics              | false      | 12         | 1                  | 0         | 0
 _schemas                        | false      | 1          | 1                  | 0         | 0
 asgard.demo.CUSTOMERS           | false      | 1          | 1                  | 1         | 1
 asgard.demo.CUSTOMERS-raw       | false      | 1          | 1                  | 2         | 2
 docker-connect-debezium-configs | false      | 1          | 1                  | 0         | 0
 docker-connect-debezium-offsets | false      | 25         | 1                  | 0         | 0
 ratings                         | false      | 1          | 1                  | 0         | 0
[...]
-------------------------------------------------------------------------------------------------------------
ksql&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inspect_a_topic_contents_ratings">6.2. Inspect a topic contents - Ratings</h3>
<div class="paragraph">
<p>Using the <code>PRINT</code> command we can easily see column names and values within a topic&#8217;s messages. Kafka messages consist of a timestamp, key, and message (payload), which are all shown in the <code>PRINT</code> output.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Note that we don&#8217;t need to know the format of the data; KSQL introspects the data and understands how to deserialise it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; PRINT 'ratings';
Format:AVRO
22/02/18 12:55:04 GMT, 5312, {"rating_id": 5312, "user_id": 4, "stars": 4, "route_id": 2440, "rating_time": 1519304104965, "channel": "web", "message": "Surprisingly good, maybe you are getting your mojo back at long last!"}
22/02/18 12:55:05 GMT, 5313, {"rating_id": 5313, "user_id": 3, "stars": 4, "route_id": 6975, "rating_time": 1519304105213, "channel": "web", "message": "why is it so difficult to keep the bathrooms clean ?"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the KSQL prompt.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_inspect_a_topic_contents_customers">6.3. Inspect a topic contents - Customers</h3>
<div class="paragraph">
<p>Here we use the <code>FROM BEGINNING</code> argument, which tells KSQL to go back to the <em>beginning</em> of the topic and show all data from there</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; PRINT 'asgard.demo.CUSTOMERS' FROM BEGINNING;
Format:JSON
{"ROWTIME":1529499994472,"ROWKEY":"null","id":1,"first_name":"Annemarie","last_name":"Arent","email":"aarent0@cpanel.net","gender":"Female","club_status":"platinum","comments":"Organized web-enabled ability"}
{"ROWTIME":1529499994472,"ROWKEY":"null","id":2,"first_name":"Merilyn","last_name":"Doughartie","email":"mdoughartie1@dedecms.com","gender":"Female","club_status":"platinum","comments":"Optimized local definition"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the KSQL prompt. This may take up to a minute to cancel (<a href="https://github.com/confluentinc/ksql/issues/1759">#1759</a>). If it still does not cancel then just start a new KSQL CLI using the <code>docker run</code> command from above and proceed to the next step.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
<div class="sect2">
<h3 id="_ksql_offsets">6.4. KSQL offsets</h3>
<div class="paragraph">
<p>Since Apache Kafka persists data, it is possible to use KSQL to query and process data from the past, as well as new events that arrive on the topic.</p>
</div>
<div class="paragraph">
<p>To tell KSQL to process from beginning of topic run <code>SET 'auto.offset.reset' = 'earliest';</code></p>
</div>
<div class="paragraph">
<p>Run this now, so that future processing includes all existing data—this is important for the Customer data, since no new messages are arriving on this topic and thus we need to make sure we work with the messages already present.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SET 'auto.offset.reset' = 'earliest';
Successfully changed local property 'auto.offset.reset' from 'null' to 'earliest'</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_querying_and_processing_the_ratings_topic">7. Querying and processing the Ratings topic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having inspected the topics and contents of them, let&#8217;s get into some SQL now. The first step in KSQL is to register the source topic with KSQL.</p>
</div>
<div class="sect2">
<h3 id="_register_the_ratings_topic">7.1. Register the ratings topic</h3>
<div class="paragraph">
<p>The inbound event stream of ratings data is a <code>STREAM</code>—later we will talk about <code>TABLE</code>, but for now, we just need a simple <code>CREATE STREAM</code> with the appropriate values in the <code>WITH</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; CREATE STREAM ratings WITH (KAFKA_TOPIC='ratings', VALUE_FORMAT='AVRO');

 Message
---------------
 Table created
---------------</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_describe_ratings_stream">7.2. Describe ratings stream</h3>
<div class="paragraph">
<p>You&#8217;ll notice that in the above <code>CREATE STREAM</code> statement we didn&#8217;t specify any of the column names. That&#8217;s because the data is in Avro format, and the Confluent Schema Registry supplies the actual schema details. You can use <code>DESCRIBE</code> to examine an object&#8217;s columns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; DESCRIBE ratings;
Name                 : RATINGS
 Field       | Type
-----------------------------------------
 ROWTIME     | BIGINT           (system)
 ROWKEY      | VARCHAR(STRING)  (system)
 RATING_ID   | BIGINT
 USER_ID     | INTEGER
 STARS       | INTEGER
 ROUTE_ID    | INTEGER
 RATING_TIME | BIGINT
 CHANNEL     | VARCHAR(STRING)
 MESSAGE     | VARCHAR(STRING)
-----------------------------------------
For runtime statistics and query details run: DESCRIBE EXTENDED &lt;Stream,Table&gt;;
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the presence of a couple of <code>(system)</code> columns here. <code>ROWTIME</code> is the timestamp of the Kafka message—important for when we do time-based aggregations later— and <code>ROWKEY</code> is the key of the Kafka message.</p>
</div>
</div>
<div class="sect2">
<h3 id="_querying_data_in_ksql">7.3. Querying data in KSQL</h3>
<div class="paragraph">
<p>Let&#8217;s run our first SQL. As anyone familar with SQL knows, <code>SELECT *</code> will return all columns from a given object. So let&#8217;s try it!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT * FROM ratings;
1529501380124 | 6229 | 6229 | 17 | 2 | 3957 | 1529501380124 | iOS-test | why is it so difficult to keep the bathrooms clean ?
1529501380197 | 6230 | 6230 | 14 | 2 | 2638 | 1529501380197 | iOS | your team here rocks!
1529501380641 | 6231 | 6231 | 12 | 1 | 9870 | 1529501380641 | iOS-test | (expletive deleted)
[…]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll notice that the data keeps on coming. That is because KSQL is fundamentally a <em>streaming engine</em>, and the queries that you run are <em>continuous queries</em>. Having previously set the offset to <code>earliest</code> KSQL is showing us the <strong>past</strong> (data from the beginning of the topic), the <strong>present</strong> (data now arriving in the topic), and the <strong>future</strong> (all new data that arrives in the topic from now on).</p>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel the query and return to the KSQL command prompt.</p>
</div>
<div class="paragraph">
<p>To inspect a finite set of data, you can use the <code>LIMIT</code> clause. Try it out now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT * FROM ratings LIMIT 5;
1529499830648 | 1 | 1 | 8 | 1 | 7562 | 1529499829398 | ios | more peanuts please
1529499830972 | 2 | 2 | 5 | 4 | 54 | 1529499830972 | iOS | your team here rocks!
1529499831203 | 3 | 3 | 16 | 1 | 9809 | 1529499831203 | web | airport refurb looks great, will fly outta here more!
1529499831521 | 4 | 4 | 5 | 1 | 7691 | 1529499831521 | web | thank you for the most friendly, helpful experience today at your new lounge
1529499831814 | 5 | 5 | 19 | 3 | 389 | 1529499831814 | ios | thank you for the most friendly, helpful experience today at your new lounge
Limit Reached
Query terminated
ksql&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_filtering_streams_of_data_in_ksql">7.4. Filtering streams of data in KSQL</h3>
<div class="paragraph">
<p>Since KSQL is heavily based on SQL, you can do many of the standard SQL things you&#8217;d expect to be able to do, including predicates and selection of specific columns:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT USER_ID, STARS, CHANNEL, MESSAGE FROM ratings WHERE STARS &lt;3 AND CHANNEL='iOS' LIMIT 3;
3 | 2 | iOS | your team here rocks!
2 | 1 | iOS | worst. flight. ever. #neveragain
15 | 2 | iOS | worst. flight. ever. #neveragain
Limit Reached
Query terminated
ksql&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_kafka_topic_populated_by_a_filtered_stream">8. Creating a Kafka topic populated by a filtered stream</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/ksql_workshop_02.png" alt="Filtering data with KSQL">
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s take the poor ratings from people with iOS devices, and create a new stream from them!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; CREATE STREAM POOR_RATINGS AS SELECT * FROM ratings WHERE STARS &lt;3 AND CHANNEL='iOS';

 Message
----------------------------
 Stream created and running
----------------------------</code></pre>
</div>
</div>
<div class="paragraph">
<p>What this does is set a KSQL continuous query running that processes messages on the source <code>ratings</code> topic to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>applies the predicates (<code>STARS&lt;3 AND CHANNEL='iOS'`</code>)</p>
</li>
<li>
<p>selects just the specified columns</p>
<div class="ulist">
<ul>
<li>
<p>If you wanted to take all columns from the source stream, you would simply use <code>SELECT *</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each processed message is written to a new Kafka topic. Remember, this is a <em>continuous query</em>, so every single source message—past, present, and future—will be processed with low-latency in this way.</p>
</div>
<div class="paragraph">
<p><em>This method of creating derived topics is frequently referred to by the acronym of the statement—<code>CSAS</code> (&#8594; <code>CREATE STREAM … AS SELECT</code>).</em></p>
</div>
<div class="sect2">
<h3 id="_inspect_the_derived_stream">8.1. Inspect the derived stream</h3>
<div class="paragraph">
<p>Using <code>DESCRIBE</code> we can see that the new stream has the same columns as the source one.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; DESCRIBE POOR_RATINGS;
Name                 : POOR_RATINGS
 Field       | Type
-----------------------------------------
 ROWTIME     | BIGINT           (system)
 ROWKEY      | VARCHAR(STRING)  (system)
 RATING_ID   | BIGINT
 USER_ID     | INTEGER
 STARS       | INTEGER
 ROUTE_ID    | INTEGER
 RATING_TIME | BIGINT
 CHANNEL     | VARCHAR(STRING)
 MESSAGE     | VARCHAR(STRING)
-----------------------------------------
For runtime statistics and query details run: DESCRIBE EXTENDED &lt;Stream,Table&gt;;
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Additional information about the derived stream is available with the <code>DESCRIBE EXTENDED</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; DESCRIBE EXTENDED POOR_RATINGS;
Name                 : POOR_RATINGS
Type                 : STREAM
Key field            :
Key format           : STRING
Timestamp field      : Not set - using &lt;ROWTIME&gt;
Value format         : AVRO
Kafka topic          : POOR_RATINGS (partitions: 4, replication: 1)

 Field       | Type
-----------------------------------------
 ROWTIME     | BIGINT           (system)
 ROWKEY      | VARCHAR(STRING)  (system)
 RATING_ID   | BIGINT
 USER_ID     | INTEGER
 STARS       | INTEGER
 ROUTE_ID    | INTEGER
 RATING_TIME | BIGINT
 CHANNEL     | VARCHAR(STRING)
 MESSAGE     | VARCHAR(STRING)
-----------------------------------------

Queries that write into this STREAM
-----------------------------------
CSAS_POOR_RATINGS_0 : CREATE STREAM POOR_RATINGS AS SELECT * FROM ratings WHERE STARS &lt;3 AND CHANNEL='iOS';

For query topology and execution plan please run: EXPLAIN &lt;QueryId&gt;

Local runtime statistics
------------------------
messages-per-sec:     10.04   total-messages:       998     last-message: 6/20/18 1:46:09 PM UTC
 failed-messages:         0 failed-messages-per-sec:         0      last-failed:       n/a
(Statistics of the local KSQL server interaction with the Kafka topic POOR_RATINGS)
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <strong>runtime statistics</strong> above. If you re-run the <code>DESCRIBE EXTENDED</code> command you&#8217;ll see these values increasing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Local runtime statistics
------------------------
messages-per-sec:      0.33   total-messages:      1857     last-message: 6/20/18 2:33:26 PM UTC
 failed-messages:         0 failed-messages-per-sec:         0      last-failed:       n/a
(Statistics of the local KSQL server interaction with the Kafka topic POOR_RATINGS)</pre>
</div>
</div>
<div class="paragraph">
<p><em>N.B. you can use the up arrow on your keyboard to cycle through KSQL command history for easy access and replay of previous commands. Ctrl-R also works for searching command history.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_query_the_stream">8.2. Query the stream</h3>
<div class="paragraph">
<p>The derived stream that we&#8217;ve created is just another stream that we can interact with in KSQL as any other. If you run a <code>SELECT</code> against the stream you&#8217;ll see new messages arriving based on those coming from the source <code>ratings</code> topic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT STARS, CHANNEL, MESSAGE FROM POOR_RATINGS;
1 | iOS | worst. flight. ever. #neveragain
2 | iOS | Surprisingly good, maybe you are getting your mojo back at long last!
2 | iOS | thank you for the most friendly, helpful experience today at your new lounge</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the KSQL prompt.</p>
</div>
</div>
<div class="sect2">
<h3 id="_its_just_a_kafka_topic">8.3. It&#8217;s just a Kafka topic…</h3>
<div class="paragraph">
<p>The query that we created above (<code>CREATE STREAM POOR_RATINGS AS…</code>) populates a Kafka topic, which we can also access as a KSQL stream (as in the previous step). Let&#8217;s inspect this topic now, using KSQL.</p>
</div>
<div class="paragraph">
<p>Observe that the topic exists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SHOW TOPICS;

 Kafka Topic        | Registered | Partitions | Partition Replicas | Consumers | ConsumerGroups
------------------------------------------------------------------------------------------------
 _confluent-metrics | false      | 12         | 1                  | 0         | 0
 _schemas           | false      | 1          | 1                  | 0         | 0
 customers          | false      | 1          | 1                  | 0         | 0
 POOR_RATINGS       | true       | 4          | 1                  | 0         | 0
 ratings            | true       | 1          | 1                  | 1         | 1
------------------------------------------------------------------------------------------------
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inspect the Kafka topic&#8217;s data</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">ksql&gt; print 'POOR_RATINGS';
Format:AVRO
6/20/18 11:01:03 AM UTC, 37, {"RATING_ID": 37, "USER_ID": 12, "STARS": 2, "ROUTE_ID": 8916, "RATING_TIME": 1529492463400, "CHANNEL": "iOS", "MESSAGE": "more peanuts please"}
6/20/18 11:01:07 AM UTC, 55, {"RATING_ID": 55, "USER_ID": 10, "STARS": 2, "ROUTE_ID": 5232, "RATING_TIME": 1529492467552, "CHANNEL": "iOS", "MESSAGE": "why is it so difficult to keep the bathrooms clean ?"}</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_joining_data_in_ksql">9. Joining Data in KSQL</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/ksql_workshop_03.png" alt="Joining data with KSQL">
</div>
</div>
<div class="paragraph">
<p>Remember our Customer data? Let&#8217;s bring that into play, and use it to enrich the inbound stream of ratings data to show against each rating who the customer is, and their club status ('platinum','gold', etc).</p>
</div>
<div class="sect2">
<h3 id="_prepare_the_customer_data">9.1. Prepare the Customer data</h3>
<div class="paragraph">
<p>We&#8217;re going to model the Customers topic as a <strong>KSQL Table</strong>. This is a semantic construct that enables us to work with the data in the topic as key/value pairs, with a single value for each key. You can read more about <a href="https://docs.confluent.io/current/streams/concepts.html#duality-of-streams-and-tables">this here</a>.</p>
</div>
<div class="sect3">
<h4 id="_inspect_customers_data">9.1.1. Inspect Customers Data</h4>
<div class="paragraph">
<p>Let&#8217;s check the data first, using the very handy <code>PRINT</code> command:</p>
</div>
<div class="paragraph">
<p><code>PRINT 'asgard.demo.CUSTOMERS' FROM BEGINNING;</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; PRINT 'asgard.demo.CUSTOMERS' FROM BEGINNING;
Format:JSON
{"ROWTIME":1529492614185,"ROWKEY":"null","id":1,"first_name":"Annemarie","last_name":"Arent","email":"aarent0@cpanel.net","gender":"Female","club_status":"platinum","comments":"Organized web-enabled ability"}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel and return to the KSQL prompt. This may take up to a minute to cancel (<a href="https://github.com/confluentinc/ksql/issues/1759">#1759</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_re_key_customers_topic">9.1.2. Re-Key Customers Topic</h4>
<div class="paragraph">
<p>When we join the customer data to the ratings, the customer Kafka messages <em>must be keyed on the field on which we are performing the join</em>. If this is not the case the join will fail and we&#8217;ll get <code>NULL</code> values in the result.</p>
</div>
<div class="paragraph">
<p>Our source customer messages are not currently keyed correctly. Depending on how you chose to populate the Customer topic earlier:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From Debezium, the messages are actually keyed using the Primary Key of the source table, but using a key serialisation that KSQL does not support - and thus in effect is not useful as a key in KSQL at all</p>
</li>
<li>
<p>From a manual input of JSON messages, the key is null (observe the <code>"ROWKEY":"null"</code> in the <code>PRINT</code> output above)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To re-key a topic in Kafka we can use KSQL!</p>
</div>
<div class="paragraph">
<p>First we will register the customer topic. Note that because it is in JSON format we need to declare all of the columns and their datatypes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; CREATE STREAM CUSTOMERS_SRC (id BIGINT, first_name VARCHAR, last_name VARCHAR, email VARCHAR, gender VARCHAR, club_status VARCHAR, comments VARCHAR) WITH (KAFKA_TOPIC='asgard.demo.CUSTOMERS', VALUE_FORMAT='JSON');

 Message
----------------
 Stream created
----------------
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the stream registered, we can now re-key the topic, using a KSQL <code>CSAS</code> and the <code>PARTITION BY</code> clause. Note that we&#8217;re taking the opportunity to re-serialise the data into Avro format. We&#8217;re also changing the number of partitions from that of the source (4) to match that of the <code>ratings</code> topic (1):</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
<div class="paragraph">
<p>By changing the partition key, data may move between partitions, and thus its ordering change. Kafka&#8217;s strict ordering guarantee only applies within a partition.</p>
</div>
<div class="paragraph">
<p>In our example this doesn&#8217;t matter, but be aware of this if you rely on this re-keying technique in other KSQL queries.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; CREATE STREAM CUSTOMERS_SRC_REKEY \
        WITH (PARTITIONS=1, VALUE_FORMAT='AVRO') AS \
        SELECT * FROM CUSTOMERS_SRC PARTITION BY ID;

 Message
----------------------------
 Stream created and running
----------------------------
ksql&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Optional</strong></p>
</div>
<div class="paragraph">
<p>To inspect the key for a given stream/table, use the <code>ROWKEY</code> system column.</p>
</div>
<div class="paragraph">
<p>Here we compare it to the join column (<code>ID</code>); for the join to succeed they must be equal.</p>
</div>
<div class="paragraph">
<p>In the source stream, the <code>ROWKEY</code> is null (or <code>Struct{id=x}</code> if streamed from Debezium) because the key of the underlying Kafka messages is null:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT C.ROWKEY, C.ID FROM CUSTOMERS_SRC C LIMIT 3;
null | 1
null | 2
null | 3
Limit Reached
Query terminated</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the re-keyed stream the <code>ROWKEY</code> and <code>ID</code> are equal, which is essential for a successful JOIN operation in KSQL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT C.ROWKEY, C.ID FROM CUSTOMERS_SRC_REKEY C LIMIT 3;
1 | 1
2 | 2
3 | 3
Limit Reached
Query terminated
ksql&gt;</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_create_customers_table">9.1.3. Create Customers Table</h4>
<div class="paragraph">
<p>Now, create a <code>TABLE</code> over the new re-keyed Kafka topic. Why&#8217;s it a table? Because <strong>for each key</strong> (user id), we want to know <strong>its current value</strong> (name, status, etc)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; CREATE TABLE CUSTOMERS WITH (KAFKA_TOPIC='CUSTOMERS_SRC_REKEY', VALUE_FORMAT ='AVRO', KEY='ID');

 Message
---------------
 Table created
---------------
ksql&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>n.b. if you get the error <code>Unable to verify the AVRO schema is compatible with KSQL</code> then</em> :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retry the command after a second or two (ref. <a href="https://github.com/confluentinc/ksql/issues/1394">#1394</a>).</p>
</li>
<li>
<p>Check that the topic&#8217;s source stream is created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SHOW STREAMS;
 Stream Name         | Kafka Topic         | Format
----------------------------------------------------
 CUSTOMERS_SRC_REKEY | CUSTOMERS_SRC_REKEY | AVRO
 [...]</code></pre>
</div>
</div>
</li>
<li>
<p>Verify that the source stream is processing messages by running <code>DESCRIBE EXTENDED CUSTOMERS_SRC_REKEY;</code>. Under the heading <code>Local runtime statistics</code> you should see:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">Local runtime statistics
------------------------
messages-per-sec:      0.10   total-messages:        10     last-message: 6/28/18 6:23:54 PM UTC
 failed-messages:         0 failed-messages-per-sec:         0      last-failed:       n/a</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If no 'messages-per-sec' is shown, the next step is to verify that you ran <code>SET 'auto.offset.reset' = 'earliest';</code> earlier. You can run it again to be certain. If it says <code>Successfully changed local property 'auto.offset.reset' from 'null' to 'earliest'</code> then the <code>null</code> shows that it wasn&#8217;t previously set.</p>
</li>
<li>
<p>If this was the case, then you need to drop and recreate the stream in order to process the customer data:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">TERMINATE QUERY CSAS_CUSTOMERS_SRC_REKEY_0;
DROP STREAM CUSTOMERS_SRC_REKEY;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then re-run the <code>CREATE STREAM CUSTOMERS_SRC_REKEY[…]</code> from above. Use <code>SHOW QUERIES;</code> to list the queries running if the name differs from that shown in the <code>TERMINATE</code> statement.</p>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Query the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT ID, FIRST_NAME, LAST_NAME, EMAIL, CLUB_STATUS FROM CUSTOMERS;
1 | Annemarie | Arent | aarent0@cpanel.net | platinum
2 | Merilyn | Doughartie | mdoughartie1@dedecms.com | platinum</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect2">
<h3 id="_stream_table_join">9.2. Stream-Table join</h3>
<div class="paragraph">
<p>Now let&#8217;s join our ratings data (<code>RATINGS</code>), which includes user ID, to our user information (<code>CUSTOMERS</code>).</p>
</div>
<div class="paragraph">
<p>Run the following SQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT R.MESSAGE, C.FIRST_NAME, C.LAST_NAME \
FROM RATINGS R INNER JOIN CUSTOMERS C \
ON R.USER_ID = C.ID \
LIMIT 5;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a couple of things to note about this query :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We&#8217;re aliasing the table and stream names to make column names unambiguous</p>
</li>
<li>
<p>I&#8217;m using the backspace line continuation character</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the output you should see a rating message, and the name of the customer who left it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">more peanuts please | Gianina | Mixhel
your team here rocks! | Munmro | Igounet
airport refurb looks great, will fly outta here more! | null | null
thank you for the most friendly, helpful experience today at your new lounge | Munmro | Igounet
thank you for the most friendly, helpful experience today at your new lounge | null | null
Limit Reached
Query terminated
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s pull the full set of data, including a reformat of the timestamp into something human readable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT TIMESTAMPTOSTRING(R.RATING_TIME, 'yyyy-MM-dd HH:mm:ss'), R.RATING_ID, R.STARS, R.ROUTE_ID,  R.CHANNEL, \
R.MESSAGE, C.FIRST_NAME, C.LAST_NAME, C.CLUB_STATUS \
FROM RATINGS R INNER JOIN CUSTOMERS C \
ON R.USER_ID = C.ID;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">2018-06-20 13:03:49 | 1 | 1 | 7562 | ios | more peanuts please | Gianina | Mixhel | gold
2018-06-20 13:03:50 | 2 | 4 | 54 | iOS | your team here rocks! | Munmro | Igounet | gold
2018-06-20 13:03:51 | 4 | 1 | 7691 | web | thank you for the most friendly, helpful experience today at your new lounge | Munmro | Igounet | gold
2018-06-20 13:03:51 | 6 | 2 | 6902 | web | Surprisingly good, maybe you are getting your mojo back at long last! | Gianina | Mixhel | gold</code></pre>
</div>
</div>
<div class="paragraph">
<p>Press Ctrl-C to cancel the output.</p>
</div>
<div style="page-break-after: always;"></div>
<div class="sect3">
<h4 id="_populating_a_kafka_topic_with_the_results_of_a_stream_table_join">9.2.1. Populating a Kafka topic with the results of a Stream-Table join</h4>
<div class="paragraph">
<p>Let&#8217;s persist this as an enriched stream, by simply prefixing the query with <code>CREATE STREAM … AS</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE STREAM RATINGS_WITH_CUSTOMER_DATA WITH (PARTITIONS=1) AS \
SELECT R.RATING_ID, R.CHANNEL, R.STARS, R.MESSAGE, \
       C.ID, C.CLUB_STATUS, C.EMAIL, \
       C.FIRST_NAME, C.LAST_NAME \
FROM RATINGS R \
     INNER JOIN CUSTOMERS C \
       ON R.USER_ID = C.ID ;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql"> Message
----------------------------
 Stream created and running
----------------------------</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_filtering_an_enriched_stream">9.3. Filtering an enriched stream</h3>
<div class="paragraph">
<p>Now that we have customer information added to every rating event, we can easily answer questions such as "Which of our Premier customers are not happy?":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT EMAIL, STARS, MESSAGE \
FROM RATINGS_WITH_CUSTOMER_DATA \
WHERE CLUB_STATUS='platinum' \
  AND STARS &lt;3;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">aarent0@cpanel.net | 2 | thank you for the most friendly, helpful experience today at your new lounge
mdoughartie1@dedecms.com | 1 | worst. flight. ever. #neveragain</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_daisy_chaining_derived_streams">10. Daisy-chaining derived streams</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/ksql_workshop_04.png" alt="Filtering enriched data with KSQL">
</div>
</div>
<div class="paragraph">
<p>Having enriched the initial stream of ratings events with customer data, we can now persist a filtered version of that stream that includes a predicate to identify just those VIP customers who have left bad reviews:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE STREAM UNHAPPY_PLATINUM_CUSTOMERS AS \
SELECT CLUB_STATUS, EMAIL, STARS, MESSAGE \
FROM   RATINGS_WITH_CUSTOMER_DATA \
WHERE  STARS &lt; 3 \
  AND  CLUB_STATUS = 'platinum';</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql"> Message
----------------------------
 Stream created and running
----------------------------
ksql&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_query_the_new_stream">10.1. Query the new stream</h3>
<div class="paragraph">
<p>Now we can query the derived stream to easily identify important customers who are not happy. Since this is backed by a Kafka topic being continually popuated by KSQL we can also drive other applications with this data, as well as land it to datastores down-stream for visualisation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">ksql&gt; SELECT STARS, MESSAGE, EMAIL FROM UNHAPPY_PLATINUM_CUSTOMERS;
1 | is this as good as it gets? really ? | aarent0@cpanel.net
2 | airport refurb looks great, will fly outta here more! | aarent0@cpanel.net
2 | meh | aarent0@cpanel.net</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streaming_aggregates">11. Streaming Aggregates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>KSQL can create aggregations of event data, either over all events to date (and continuing to update with new data), or based on a time window. The time window types supported are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tumbling (e.g. every 5 minutes : 00:00, 00:05, 00:10)</p>
</li>
<li>
<p>Hopping (e.g. every 5 minutes, advancing 1 minute: 00:00-00:05, 00:01-00:06)</p>
</li>
<li>
<p>Session (Sets a timeout for the given key, after which any new data is treated as a new session)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To understand more about these time windows, you can read the related <a href="https://docs.confluent.io/current/streams/developer-guide/dsl-api.html#windowing">Kafka Streams documentation</a>. Since KSQL is built on Kafka Streams, the concepts are the same. The <a href="https://docs.confluent.io/current/ksql/docs/tutorials/examples.html#aggregating-windowing-and-sessionization">KSQL-specific documentation</a> is also useful.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/ksql_workshop_05.png" alt="Aggregating data with KSQL">
</div>
</div>
<div class="sect2">
<h3 id="_running_count_per_minute">11.1. Running Count per Minute</h3>
<div class="paragraph">
<p>This shows the number of ratings per customer status, per minute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT CLUB_STATUS, COUNT(*) AS RATING_COUNT \
FROM RATINGS_WITH_CUSTOMER_DATA \
     WINDOW TUMBLING (SIZE 1 MINUTES) \
GROUP BY CLUB_STATUS;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">platinum | 1
bronze | 2
gold | 12
bronze | 13</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the time window itself is not shown in the output here. To access that we need to persist the results. Instead of <code>CREATE STREAM</code> as we did above, we&#8217;re going to instead persist with a <code>CREATE TABLE</code>, since aggregates are always a table (key + value). Just as before though, a Kafka topic is continually populated with the results of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE RATINGS_BY_CLUB_STATUS AS \
SELECT CLUB_STATUS, COUNT(*) AS RATING_COUNT \
FROM RATINGS_WITH_CUSTOMER_DATA \
     WINDOW TUMBLING (SIZE 1 MINUTES) \
GROUP BY CLUB_STATUS;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql"> Message
---------------------------
 Table created and running
---------------------------
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the resulting <code>TABLE</code> there are some characteristics to note:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>ROWTIME</code> is the timestamp of the most recent message to arrive in that aggregate.</p>
</li>
<li>
<p>The <code>ROWKEY</code> is a composite key of the window start timestamp as an epoch, plus the column(s) defined in the <code>GROUP BY</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using the <code>ROWKEY</code> column it&#8217;s possible to examine the aggregate values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT ROWKEY, \
        CLUB_STATUS, RATING_COUNT \
FROM RATINGS_BY_CLUB_STATUS \
LIMIT 5;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">platinum : Window{start=1535986500000 end=-} | platinum | 23
silver : Window{start=1535983740000 end=-} | silver | 9
gold : Window{start=1535983740000 end=-} | gold | 39
gold : Window{start=1535983800000 end=-} | gold | 46
platinum : Window{start=1535983980000 end=-} | platinum | 18
Limit Reached
Query terminated
ksql&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This table that we&#8217;ve created is just a first class object in KSQL, updated in real time with the results from the aggregate query. Because it&#8217;s just another object in KSQL, we can query and filter it as any other:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">SELECT ROWKEY, \
        CLUB_STATUS, RATING_COUNT \
FROM RATINGS_BY_CLUB_STATUS \
WHERE CLUB_STATUS='bronze';</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">bronze : Window{start=1535986740000 end=-} | bronze | 23
bronze : Window{start=1535986800000 end=-} | bronze | 22
bronze : Window{start=1535986860000 end=-} | bronze | 35
bronze : Window{start=1535986920000 end=-} | bronze | 25
bronze : Window{start=1535986980000 end=-} | bronze | 30</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you let the <code>SELECT</code> output continue to run, you&#8217;ll see all of the past time window aggregate values—but also the current one. Note that the <em>current</em> time window&#8217;s aggregate value will continue to update, because new events are being continually processed and reflected in the value. If you were to send an event to the source <code>ratings</code> topic with a timestamp in the past, the corresponding time window&#8217;s aggregate would be re-emitted.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optional_stream_data_to_elasticsearch">12. Optional: Stream data to Elasticsearch</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This section assumes that you are familiar with the use of Kibana
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using Kafka Connect you can stream data from a Kafka to one (or many) targets, including Elasticsearch, HDFS, S3, and so on.</p>
</div>
<div class="paragraph">
<p>Here we&#8217;ll see how to stream it to Elasticsearch for rapid visualisation and analysis.</p>
</div>
<div class="paragraph">
<p>From a bash prompt, make sure that Elasticsearch and Kibana are running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-compose ps|egrep "elasticsearch|kibana"
elasticsearch                      /usr/local/bin/docker-entr ...   Up      0.0.0.0:9200-&gt;9200/tcp, 0.0.0.0:9300-&gt;9300/tcp
kibana                             /usr/local/bin/kibana-docker     Up      0.0.0.0:5601-&gt;5601/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a dynamic mapping in Elasticsearch so that the timestamp of source data is correctly detected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-compose exec kafka-connect-cp bash -c '/scripts/create-elastic-source.sh'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker exec -it &lt;container name&gt; /bin/bash</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -XPUT "http://localhost:9200/_template/kafkaconnect/" -H 'Content-Type: application/json' -d' { "index_patterns": "*", "settings": { "number_of_shards": 1, "number_of_replicas": 0 }, "mappings": { "_default_": { "dynamic_templates": [ { "dates": { "match": "TS", "mapping": { "type": "date" } } }, { "non_analysed_string_template": { "match": "*", "match_mapping_type": "string", "mapping": { "type": "keyword" } } } ] } } }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a connector to stream <code>RATINGS_WITH_CUSTOMER_DATA</code> to Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X "POST" "http://localhost:18083/connectors/" \
-H "Content-Type: application/json" \
-d '{
  "name": "es_sink_unhappy_platinum_customers",
  "config": {
    "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",
    "topics": "RATINGS_WITH_CUSTOMER_DATA",
    "key.converter": "org.apache.kafka.connect.storage.StringConverter",
    "key.ignore": "true",
    "schema.ignore": "true",
    "type.name": "type.name=kafkaconnect",
    "topic.index.map": "RATINGS_WITH_CUSTOMER_DATA:ratings_with_customer_data",
    "connection.url": "http://elasticsearch:9200",
    "transforms": "ExtractTimestamp",
    "transforms.ExtractTimestamp.type": "org.apache.kafka.connect.transforms.InsertField$Value",
    "transforms.ExtractTimestamp.timestamp.field" : "TS"
  }
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a connector to stream <code>RATINGS_BY_CLUB_STATUS</code> to Elasticsearch:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl -X "POST" "http://localhost:18083/connectors/" \
-H "Content-Type: application/json" \
-d '{
  "name": "es_sink_ratings_agg_by_status_1min",
  "config": {
    "connector.class": "io.confluent.connect.elasticsearch.ElasticsearchSinkConnector",
    "topics": "RATINGS_BY_CLUB_STATUS",
    "key.converter": "org.apache.kafka.connect.storage.StringConverter",
    "key.ignore": "false",
    "schema.ignore": "true",
    "type.name": "type.name=kafkaconnect",
    "topic.index.map": "RATINGS_BY_CLUB_STATUS:ratings_agg_by_status_1min",
    "connection.url": "http://elasticsearch:9200",
    "transforms": "ExtractTimestamp",
    "transforms.ExtractTimestamp.type": "org.apache.kafka.connect.transforms.InsertField$Value",
    "transforms.ExtractTimestamp.timestamp.field" : "TS"
  }
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note that the above sets <code>"key.ignore": "false"</code> , and thus aggregates will be updated in-place.</em></p>
</div>
<div class="paragraph">
<p>If you have <code>jq</code> on your machine you can run this to check that the connector is <code>RUNNING</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ curl -s "http://localhost:18083/connectors"| jq '.[]'| xargs -I{connector_name} curl -s "http://localhost:18083/connectors/"{connector_name}"/status"| jq -c -M '[.name,.connector.state,.tasks[].state]|join(":|:")'| column -s : -t| sed 's/\"//g'| sort

es_sink_ratings_agg_by_status_1min  |  RUNNING  |  RUNNING
es_sink_unhappy_platinum_customers  |  RUNNING  |  RUNNING</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the Kibana interface (<a href="http://localhost:5601" class="bare">http://localhost:5601</a>) to check that docs are arriving in Elasticsearch:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kibana_01.png" alt="kibana 01">
</div>
</div>
<div class="paragraph">
<p>Add the index pattern to Kibana, and then use the Discover and Visualise options to explore and create analyses on the data:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kibana_02.png" alt="kibana 02">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/kibana_03.png" alt="kibana 03">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shutting_down_the_environment">13. Shutting down the environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To terminate the workshop environment, run <code>docker-compose down</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-compose down
Stopping ksql-workshop_ksql-server_1     ... done
Stopping ksql-workshop_datagen-ratings_1 ... done
Stopping ksql-workshop_schema-registry_1 ... done
Stopping ksql-workshop_kafka_1           ... done
Stopping ksql-workshop_zookeeper_1       ... done
Removing ksql-workshop_ksql-server_1     ... done
Removing ksql-workshop_datagen-ratings_1 ... done
Removing ksql-workshop_schema-registry_1 ... done
Removing ksql-workshop_kafka_1           ... done
Removing ksql-workshop_zookeeper_1       ... done
Removing network ksql-workshop_default</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>If you want to preserve the state of all containers, run <code>docker-compose stop</code> instead.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps">14. Next steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the enriched and filtered data being populated into Kafka topics from KSQL you can use it to :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Feed event-driven applications. For example, notify the ops team if a VIP user leaves a poor review.</p>
</li>
<li>
<p>Stream to analytics platforms. For example, use Kafka Connect to stream the enriched data stream to Elasticsearch and visualise the real time with Kibana.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.32<br>
Last updated 2019-02-18 17:28:42 +0100
</div>
</div>
</body>
</html>